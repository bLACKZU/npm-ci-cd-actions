name: On-Demand Staging

on:
  workflow_dispatch:
    inputs:
      PR_number:
        description: 'Pull request number'
        required: true
permissions:
  id-token: write
  contents: read
jobs:
  create:
    name: Create Staging Environment and Deploy
    defaults:
      run:
        shell: bash
    runs-on: ubuntu-latest
    
    steps:
    - name: Verify PR Number
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        result-encoding: string
        script: |
            const response = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: ${{ inputs.PR_number }},
            });
            if (response.data.number !== ${{ inputs.PR_number }}) {
              throw new Error('Pull request is not open or number is not valid!');
            } else {
              console.log("PR ref: " + response.data.head.ref);
              return response.data.head.ref;
            }
    
    - name: Checkout infra Code
      uses: actions/checkout@v4
      with:
        repository: bLACKZU/npm-infra
        path: npm-infra
    
    - name: List files
      run: |
        echo "Files in parent directory:"
        ls -l
        echo "Files in npm-infra directory:" 
        ls -l npm-infra
        pwd

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.1.7"
  
    - name: Create stage environment resource file
      id: create_stage_resource_file
      run: |
        current=$(pwd)
        chmod +x $current/npm-infra/staging/create_staging_resource.sh
        OUTPUT="$($current/npm-infra/staging/create_staging_resource.sh PR_${{ inputs.PR_number }} | jq -r .terraform_expected_output)"
        echo "STAGING_RESOURCE_NAME=$OUTPUT" >> $GITHUB_OUTPUT

    - name: Terraform Init & Validate
      id: init
      working-directory: ${{ github.workspace }}/npm-infra/staging
      run: |
        terraform init
        terraform validate -no-color

    - name: Configure AWS Credentials for China region audience
      uses: aws-actions/configure-aws-credentials@v4.1.0
      with:
        aws-region: us-east-1
        role-to-assume: ${{ secrets.AWS_STAGING_ROLE_ARN }}

    - name: Terraform Plan
      id: plan
      working-directory: ${{ github.workspace }}/npm-infra/staging
      run: |
        terraform plan --var-file=terraform.tfvars.auto.example -no-color
      continue-on-error: true
    
    - name: Update Pull Request
      uses: actions/github-script@v7
      env:
        PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const output = `#### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
          #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`

          <details><summary>Show Plan</summary>

          \`\`\`\n
          ${process.env.PLAN}
          \`\`\`

          </details>

          *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

          github.rest.issues.createComment({
            issue_number: ${{ github.event.inputs.PR_number }},
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })
    
    - name: Terraform Plan Status
      if: ${{ steps.plan.outcome == 'failure' }}
      run: exit 1 
        